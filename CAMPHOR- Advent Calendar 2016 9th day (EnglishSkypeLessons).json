{"files":[{"id":"8dc3dc08-8501-4253-8955-11bdb1aace2c","name":"lib","type":"server_js","source":"/**\n * 検索結果のそれぞれのメールに対して与えられた処理を行う\n *\n * @param {string} criteria 検索条件。Gmailで絞り込むのと同等の文字列\n * @param {function} callback 1メールに対して行う処理。callback関数への引数にはGmailMessageが渡される\n */\nfunction eachMessage(criteria, callback) {\n  GmailApp.search(criteria).forEach(function(thread) {\n    thread.getMessages().forEach(callback);\n  });\n}\n\n/**\n * 検索結果の未読メールに対して与えられた処理を行た後、既読にする\n *\n * @param {string} criteria 検索条件。Gmailで絞り込むのと同等の文字列\n * @param {function} callback 1メールに対して行う処理。callback関数への引数にはGmailMessageが渡される\n */\nfunction eachUnreadMessage(criteria, callback) {\n  GmailApp.search(criteria).forEach(function(thread) {\n    thread.getMessages().forEach(function (message) {\n         if (message.isUnread()) {\n             callback(message);\n             message.markRead();\n         }\n     });\n  });\n}\n\n/**\n * 検索結果のメールを削除する\n *\n * @param {string} criteria 検索条件。Gmailで絞り込むのと同等の文字列\n * @param {function} callback 1メールに対して行う処理。callback関数への引数にはGmailMessageが渡される\n */\nfunction deleteMessage(criteria, callback) {\n  GmailApp.search(criteria).forEach(function(thread) {\n    thread.getMessages().forEach(function (message) {\n        if(!message.isStarred()){\n          callback(message);\n          message.moveToTrash();\n        }\n     });\n  });\n}\n\n/**\n * デフォルトのカレンダーにイベントを登録する\n *\n * @param {string} title イベントのタイトル\n * @param {Date} startDate イベントが始まる時刻\n * @param {Date} endDate イベントが終わる時刻\n */\nfunction createEvent(title, startDate, endDate) {\n  if (!(title \u0026\u0026 startDate \u0026\u0026 endDate)) {\n      return;\n  }\n  var cal \u003d CalendarApp.getDefaultCalendar();\n  var event \u003d cal.createEvent(title, startDate, endDate);\n  event.setColor(CalendarApp.EventColor.RED);\n  Logger.log(\u0027Event ID: \u0027 + event.getTitle() + \u0027[\u0027 + startDate + \u0027~\u0027 + endDate + \u0027] is created\u0027);\n}"},{"id":"18a2e7c7-43a6-4f57-83ff-4e0ae0504688","name":"DMMEnglish","type":"server_js","source":"function DMMEnglish() {\n  var criteria \u003d \"from:info@eikaiwa.dmm.com レッスン予約完了\";\n  eachUnreadMessage(criteria, function (message) {\n    var body \u003d message.getBody();\n    var [matched, year, month, day] \u003d /ご予約日：(\\d+)年(\\d\\d)月(\\d\\d)日/.exec(body);\n    var [matched, sh, sm] \u003d /開始時間：(\\d\\d)時(\\d\\d)分/.exec(body);\n    var sdate \u003d new Date(year, month-1, day, sh, sm);\n    var edate \u003d new Date(sdate.getTime() + 30 * 60000);\n    createEvent(\"DMM英会話\", sdate, edate);\n  }\n  );\n}\n"},{"id":"1a539d85-ded6-4a92-9c0a-e4d4b94b91f4","name":"RarejobEnglish","type":"server_js","source":"function RarejobEnglish() {\n  var criteria \u003d \"from:donotreply@rarejob.com レッスン予約完了\";\n  eachUnreadMessage(criteria, function (message) {\n    var regex \u003d /(\\d\\d\\d\\d)\\/(\\d?\\d)\\/(\\d\\d) ..(\\d\\d):(\\d\\d) - ..(\\d\\d):(\\d\\d)/;\n    var match \u003d regex.exec(message.getSubject());\n    var [matched, year, month, day, sh, sm, eh, em] \u003d match;\n    createEvent(\"レアジョブ英会話\",\n                new Date(year, month-1, day, sh, sm),\n                new Date(year, month-1, day, eh, em));\n  }\n  );\n}\n"},{"id":"06730f23-8fc3-477c-83c2-5c319cf84865","name":"BestTeacher","type":"server_js","source":"function BestTeacher() {\n  var criteria \u003d \"from:noreply@best-teacher-inc.com レッスン予約完了\";\n  eachUnreadMessage(criteria, function (message) {\n    var regex \u003d /日時:(\\d\\d\\d\\d)年(\\d?\\d)月(\\d\\d)日 (\\d\\d):(\\d\\d) - (\\d\\d):(\\d\\d)/;\n    var match \u003d regex.exec(message.getBody());\n    var [matched, year, month, day, sh, sm, eh, em] \u003d match;\n    createEvent(\"BestTeacher(英会話)\",\n                new Date(year, month-1, day, sh, sm),\n                new Date(year, month-1, day, eh, em));\n  }\n  );\n}\n"},{"id":"f9ef6331-61a8-4fc5-bf6e-1a24a0a96653","name":"QQEnglish","type":"server_js","source":"function QQEnglish() {\n  var criteria \u003d \"from:noreply@notify.qqeng.com 【QQEnglish】レッスン予約完了\";\n  eachUnreadMessage(criteria, function (message) {\n    var regex \u003d /(\\d\\d\\d\\d)-(\\d\\d)-(\\d\\d) (\\d\\d):(\\d\\d)-(\\d\\d):(\\d\\d)/;\n    var regex2 \u003d /カリキュラム：(.*[\\n\\r])/\n    var match \u003d regex.exec(message.getSubject());\n    var match2 \u003d regex2.exec(message.getBody())[0];\n    var [matched, year, month, day, sh, sm, eh, em] \u003d match;\n    createEvent(\"QQ \" + match2.substr(7),\n                new Date(year, month-1, day, sh, sm),\n                new Date(year, month-1, day, eh, em));\n  }\n  );\n}\n"},{"id":"a928c678-30f9-45f6-a913-1bab1feba709","name":"appsscript","type":"json","source":"{\n  \"timeZone\": \"Asia/Tokyo\",\n  \"dependencies\": {\n    \"enabledAdvancedServices\": [{\n      \"userSymbol\": \"Gmail\",\n      \"serviceId\": \"gmail\",\n      \"version\": \"v1\"\n    }, {\n      \"userSymbol\": \"Calendar\",\n      \"serviceId\": \"calendar\",\n      \"version\": \"v3\"\n    }]\n  },\n  \"exceptionLogging\": \"STACKDRIVER\"\n}"},{"id":"02fbd4eb-4062-4e42-a335-87de7fe1ae28","name":"AccountBook","type":"server_js","source":"\n// SheetのURLは毎月変更すること！\nvar accountBookUrl \u003d \"https://docs.google.com/spreadsheets/d/1wHO2SbrQdF9r8m4Q-f_QtO8YGGP93hG4tsAaJMJjZcY/edit#gid\u003d916648353\";\n\nfunction addTransaction(){\n  addTransactionForDevitCard();\n  addTransactionForCreditCardConfirmed();\n  addTransactionForCreditCardPremilinary();\n}\n\nfunction isAppropriateDate(date){\n  var month \u003d date.getMonth();\n  if(!isThisMonth(month)){\n    return false;\n  }\n  var resultSheet \u003d SpreadsheetApp.openByUrl(accountBookUrl).getSheetByName(\u0027Expenses\u0027);\n  var doneDate \u003d new Date((resultSheet.getRange(\u0027B1\u0027).getValue() - 25569) * 86400000);\n  Logger.log(\u0027doneDate:\u0027 + doneDate.getDate() 　+ \u0027 payday:\u0027 +　date.getDate());\n  if(date.getDate() \u003c\u003d doneDate.getDate()){\n    return false;\n  }\n  return true;\n}\n\nfunction isThisMonth(month){\n  var thisMonth \u003d new Date().getMonth();\n  if(thisMonth \u003d\u003d month){\n    return true;\n  }else{\n    Logger.log(month + \u0027 is not this Month!!\u0027);\n    return false;\n  }\n}\n\nfunction addTransactionForDevitCard(){\n  var criteria \u003d \"from:service@ac.rakuten-bank.co.jp デビットカードご利用通知メール\";\n  eachUnreadMessage(criteria, function (message) {\n    var resultSheet \u003d SpreadsheetApp.openByUrl(accountBookUrl).getSheetByName(\u0027Expenses\u0027);\n    var regex \u003d /\\d{1,5}円/;\n    var match \u003d regex.exec(message.getBody())[0];\n    var priceValue \u003d match.replace(/円/, \"\");\n    var date \u003d new Date();\n    registerTransactionRecord(priceValue, resultSheet, \u0027楽デビ\u0027,Utilities.formatDate(date,\"JST\",\"MM/dd\"));\n  });\n}\n\nfunction addTransactionForCreditCardConfirmed(){\n  var criteria \u003d \"from:info@mail.rakuten-card.co.jp カード利用のお知らせ(本人ご利用分)　-【速報版】 \";\n  eachUnreadMessage(criteria, function (message) {\n    var resultSheet \u003d SpreadsheetApp.openByUrl(accountBookUrl).getSheetByName(\u0027Expenses\u0027);\n    var regex \u003d /\u003cfont size\u003d\u0027-1\u0027\u003e\\d\\d\\d\\d\\/\\d\\d\\/\\d\\d.*本人\u003c\\/font\u003e\u003c\\/td\u003e\u003ctd align\u003d\u0027center\u0027\u003e\u003cfont size\u003d\u0027-1\u0027\u003e1回\u003c\\/font\u003e\u003c\\/td\u003e\u003ctd align\u003d\u0027right\u0027\u003e\u003cfont size\u003d\u0027-1\u0027\u003e[\\d,,]{1,7} 円/g;\n    var match \u003d message.getBody().match(regex);\n    var len;\n    if(match \u003d\u003d null){\n      len \u003d 0;\n    }else{\n      len \u003d match.length;\n    }\n    var priceValue \u003d \u0027\u0027;\n    var remarksValue \u003d \u0027\u0027;\n    var regex2 \u003d /\\d\\d\\d\\d\\/\\d\\d\\/\\d\\d/;\n    var regex3 \u003d /\u003cfont size\u003d\u0027-1\u0027\u003e\\d\\d\\d\\d\\/\\d\\d\\/\\d\\d\u003c\\/font\u003e\u003c\\/td\u003e\u003ctd align\u003d\u0027left\u0027\u003e\u003cfont size\u003d\u0027-1\u0027\u003e.*\u003c\\/font\u003e\u003c\\/td\u003e\u003ctd align\u003d\u0027center\u0027\u003e\u003cfont size\u003d\u0027-1\u0027\u003e本人/;\n    var dateStr \u003d \u00271987/12/21\u0027;\n    for (var i \u003d 0; i \u003c len; ++i) {\n        dateStr \u003d (String(match[i]).match(regex2))[0];\n        var date \u003d new Date(dateStr);\n        remarksValue \u003d String(match[i]).replace(/^\u003cfont size\u003d\u0027-1\u0027\u003e\\d\\d\\d\\d\\/\\d\\d\\/\\d\\d\u003c\\/font\u003e\u003c\\/td\u003e\u003ctd align\u003d\u0027left\u0027\u003e\u003cfont size\u003d\u0027-1\u0027\u003e/, \u0027\u0027).replace(/\u003c\\/font\u003e\u003c\\/td\u003e\u003ctd align\u003d\u0027center\u0027\u003e\u003cfont size\u003d\u0027-1\u0027\u003e本人.*$/,\u0027\u0027);\n        priceValue \u003d String(match[i]).replace(/\u003cfont size\u003d\u0027-1\u0027\u003e\\d\\d\\d\\d\\/\\d\\d\\/\\d\\d.*本人\u003c\\/font\u003e\u003c\\/td\u003e\u003ctd align\u003d\u0027center\u0027\u003e\u003cfont size\u003d\u0027-1\u0027\u003e1回\u003c\\/font\u003e\u003c\\/td\u003e\u003ctd align\u003d\u0027right\u0027\u003e\u003cfont size\u003d\u0027-1\u0027\u003e/, \"\").replace(/ 円/,\u0027\u0027).replace(/,/,\u0027\u0027);\n        if(priceValue !\u003d null \u0026\u0026 priceValue \u003c 500 \u0026\u0026 isAppropriateDate(date)){\n          registerTransactionRecord(priceValue, resultSheet, \u0027楽クレ確:\u0027+ remarksValue,Utilities.formatDate(date,\"JST\",\"MM/dd\"));\n        }\n    }\n  });\n}\n\nfunction addTransactionForCreditCardPremilinary(){\n  var criteria \u003d \"from:info@mail.rakuten-card.co.jp 【速報版】カード利用のお知らせ(本人ご利用分)\";\n  eachUnreadMessage(criteria, function (message) {\n    var resultSheet \u003d SpreadsheetApp.openByUrl(accountBookUrl).getSheetByName(\u0027Expenses\u0027);\n    var regex \u003d /\u003ctr\u003e\u003ctd align\u003d\u0027center\u0027\u003e\u003cfont size\u003d\u0027-1\u0027\u003e\\d\\d\\d\\d\\/\\d\\d\\/\\d\\d\u003c\\/font\u003e\u003c\\/td\u003e\u003ctd align\u003d\u0027center\u0027\u003e\u003cfont size\u003d\u0027-1\u0027\u003e本人\u003c\\/font\u003e\u003c\\/td\u003e\u003ctd align\u003d\u0027right\u0027\u003e\u003cfont size\u003d\u0027-1\u0027\u003e[\\d,,]{1,7} 円/g;\n    var match \u003d message.getBody().match(regex);\n    var len;\n    if(match \u003d\u003d null){\n      len \u003d 0;\n    }else{\n      len \u003d match.length;\n    }\n    var priceValue \u003d \u0027\u0027;\n    var regex2 \u003d /\\d\\d\\d\\d\\/\\d\\d\\/\\d\\d/;\n    var dateStr \u003d \u00271987/12/21\u0027;\n    for (var i \u003d 0; i \u003c len; ++i) {\n        dateStr \u003d (String(match[i]).match(regex2))[0];\n        var date \u003d new Date(dateStr);\n        month \u003d date.getMonth();\n        priceValue \u003d String(match[i]).replace(/\u003ctr\u003e\u003ctd align\u003d\u0027center\u0027\u003e\u003cfont size\u003d\u0027-1\u0027\u003e\\d\\d\\d\\d\\/\\d\\d\\/\\d\\d\u003c\\/font\u003e\u003c\\/td\u003e\u003ctd align\u003d\u0027center\u0027\u003e\u003cfont size\u003d\u0027-1\u0027\u003e本人\u003c\\/font\u003e\u003c\\/td\u003e\u003ctd align\u003d\u0027right\u0027\u003e\u003cfont size\u003d\u0027-1\u0027\u003e/, \"\").replace(/ 円/,\u0027\u0027).replace(/,/,\u0027\u0027);\n        if(priceValue !\u003d null \u0026\u0026 priceValue \u003e\u003d 500 \u0026\u0026 isAppropriateDate(date)){\n          registerTransactionRecord(priceValue, resultSheet, \u0027楽クレ速報\u0027,Utilities.formatDate(date,\"JST\",\"MM/dd\"));\n        }\n    }\n  });\n}\n\n\nfunction registerTransactionRecord(priceValue, resultSheet, remarksValue, date){\n  var kindValue \u003d getKindValue(priceValue);\n  \n  if(priceValue !\u003d \"\"){\n    for(var i \u003d 3; i \u003c 200; i++){\n      var tempValue \u003d resultSheet.getRange(\u0027E\u0027+i).getValue();\n      if(tempValue \u003d\u003d\u003d \"\"){\n        break;\n        }\n      }\n      resultSheet.getRange(\u0027D\u0027+i).setValue(kindValue);\n      resultSheet.getRange(\u0027E\u0027+i).setValue(priceValue);\n      resultSheet.getRange(\u0027F\u0027+i).setValue(remarksValue);\n      resultSheet.getRange(\u0027B\u0027+i).setValue(date);\n    }\n}\n\nfunction getKindValue(priceValue){\n  var kindValue \u003d \u0027その他\u0027;\n  if(priceValue \u003c 1000){\n      kindValue \u003d \u0027食費通常\u0027;\n  }else if(priceValue \u003e 2000){\n      kindValue \u003d \u0027飲み代\u0027;\n  }\n  return kindValue;\n}\n"},{"id":"038028d8-589f-45a0-81a2-ab45263f609e","name":"DeleteMails","type":"server_js","source":"function deleteMails() {\n  var criteria \u003d \n  \"(from:noreply@notify.qqeng.com レッスン開始３０分前です) | \" +\n  \"(from:noreply@notify.qqeng.com キャンセル受付＜送信専用＞) | \" +\n  \"(from:noreply@notify.qqeng.com 【QQEnglish】レッスン予約完了) | \" +\n  \"(from:service@ac.rakuten-bank.co.jp デビットカードご利用通知メール) | \" +\n  \"(from:info@mail.rakuten-card.co.jp カード利用のお知らせ) | \" +\n  \"(from:norreply@connpass.com) | \" +\n  \"(from:calendar-notification@google.com) | \" +\n  \"(from:info@p-kc.jp) | \" +\n  \"(from:no-reply@jmty.jp) | \" +\n  \"(from:survey@insight.rakuten.co.jp  アンケート) | \" +\n  \"(from:info@doorkeeper.jp Doorkeeperのおすすめイベント) | \" +\n  \"(from:noreply@techplay.jp) | \" +\n  \"(from:infomaster@mx.nikkei.com) | \" +\n  \"(from:mailmg@scrapmagazine.com) | \" +\n  \"(from:no-reply@|igami.com) | \" +\n  \"(from:information@onetokyo) | \" +\n  \"(from:mailmaga@isea.jp) | \" +\n  \"(from:infomaster@mx.nikkei.com) | \" +\n  \"(from:bookoffonline@shop.rakuten.co.jp) | \" +\n  \"(from:message@members-ms.jp) | \" +\n  \"(from:lancer_support@lancers.co.jp) | \" +\n  \"(from:auction-master@mail.yahoo.co.jp) | \" +\n  \"(from:finance-master@mail.yahoo.co.jp) | \" +\n  \"(from:xtech-e@nikkeibp.co.jp) | \" +\n  \"(from:premium.restaurants@mail.quandoo.sg) | \" +\n  \"(from:info@osslabo.doorkeeper.jp　 マジセミ) | \" +\n  \"(from:mobile-info-master@mail.yahoo.co.jp) | \" +\n  \"(from:prom@netbk.co.jp) | \" +\n  \"(from:information@emagazine.rakuten.co.jp) | \" +\n  \"(from:support@supporterz.jp) | \" +  \n  \"(from:information@onetokyo.org)\";\n  deleteMessage(criteria, function (message) {});\n}\n"}]}